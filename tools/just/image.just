set positional-arguments
set shell := ["bash", "-cue"]
root_dir := `git rev-parse --show-toplevel`
ctr := env("CTR", "podman")

# Define the target platform, defaulting to amd64 ---
platform := env("PLATFORM", "linux/amd64")

# Use a git commit hash as a more robust default tag than "latest"
version := env("VERSION", `git rev-parse --short HEAD`)
image := "ghcr.io/sdsc-ordes/catplus-chemboard:" + version
image_dir := root_dir + "/tools/image"

# Default recipe to list all recipes.
[private]
default:
  just --list image --no-aliases

# Build Docker images for a specific platform (for local testing)
build *args:
  cd {{root_dir}} && \
    {{ctr}} build \
      --platform {{platform}} \
      -f "{{image_dir}}/Dockerfile" \
      --build-arg VERSION={{version}} \
      -t {{image}} \
      {{args}} \
      .

# Run docker image
run *args: build
  @echo "üêã Running docker image"
  cd {{root_dir}} && \
    {{ctr}} run \
      -it \
      --rm \
      --env-file .env \
      -p 3000:3000 \
      {{args}} \
      {{image}}

# --- Push now handles the build-and-push action ---
# This is the primary recipe you will use for releases.
push *args:
  @echo "üêã Building for {{platform}} and pushing to {{image}}"
  cd {{root_dir}} && \
    {{ctr}} build \
      --platform {{platform}} \
      -f "{{image_dir}}/Dockerfile" \
      --build-arg VERSION={{version}} \
      -t {{image}} \
      {{args}} \
      --push \
      .
